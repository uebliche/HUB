name: Publish

on:
  workflow_dispatch:
    inputs:
      version_type:
        type: choice
        description: Version Type
        options:
          - release
          - beta
          - alpha
        default: release
      debug:
        type: boolean
        description: Debug build
        default: false
      publish_velocity:
        type: boolean
        description: Publish Velocity loader
        default: true
      publish_paper:
        type: boolean
        description: Publish Paper loader
        default: true
      publish_fabric:
        type: boolean
        description: Publish Fabric loader
        default: true
      publish_neoforge:
        type: boolean
        description: Publish NeoForge loader
        default: true
      publish_minestom:
        type: boolean
        description: Publish Minestom loaders
        default: true
      version:
        type: string
        description: Version to use (leave empty for auto-tag)
        default: ''
      only_description:
        type: boolean
        description: Only update the Modrinth description
        default: false

permissions:
  contents: write

env:
  DEBUG: ${{ github.event.inputs.debug }}
  VERSION_TYPE: ${{ github.event.inputs.version_type }}

jobs:
  release:
    if: ${{ github.event.inputs.only_description != 'true' }}
    runs-on: ubuntu-latest
    outputs:
      tag: ${{ steps.tag.outputs.tag }}
      notes: ${{ steps.release_notes.outputs.notes }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          fetch-tags: true

      - name: Create tag
        id: tag
        env:
          INPUT_VERSION: ${{ github.event.inputs.version }}
        run: |
          set -euo pipefail
          if [ -n "$INPUT_VERSION" ]; then
            VERSION="$INPUT_VERSION"
          else
            DATE=$(date +'%Y.%m.%d')
            TAG="$DATE"
            SUFFIX=""
            while git rev-parse --quiet --verify "refs/tags/$TAG" >/dev/null; do
              if [ -z "$SUFFIX" ]; then
                SUFFIX="a"
              else
                LAST_CHAR=$(printf '%d' "'${SUFFIX}")
                NEXT_CHAR=$((LAST_CHAR + 1))
                SUFFIX=$(printf '\\%03o' "$NEXT_CHAR")
                SUFFIX=$(printf '%b' "$SUFFIX")
              fi
              TAG="${DATE}${SUFFIX}"
            done
            VERSION="$TAG"
          fi
          BRANCH="${GITHUB_REF##*/}"
          if [ "$BRANCH" != "main" ] && [ "$BRANCH" != "master" ]; then
            VERSION="${VERSION}-${BRANCH}"
          fi
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git tag "$VERSION"
          git push origin "$VERSION"
          echo "tag=$VERSION" >> "$GITHUB_OUTPUT"
          echo "Release tag: $VERSION" >> "$GITHUB_STEP_SUMMARY"

      - name: Create GitHub release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.tag.outputs.tag }}
          generate_release_notes: true
          prerelease: ${{ github.event.inputs.version_type != 'release' }}

      - name: Collect release notes
        id: release_notes
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          TAG: ${{ steps.tag.outputs.tag }}
          VERSION_TYPE: ${{ github.event.inputs.version_type }}
          DEBUG_BUILD: ${{ github.event.inputs.debug }}
        run: |
          set -euo pipefail
          notes=$(gh api /repos/${{ github.repository }}/releases/tags/${TAG} --jq '.body // ""')
          if [ -z "$notes" ]; then
            notes="_No release notes generated by GitHub. Add a changelog to the release body if needed._"
          fi

          {
            echo "notes<<EOF"
            echo "$notes"
            echo "EOF"
          } >> "$GITHUB_OUTPUT"

          {
            echo "## Release summary"
            echo "- Tag: ${TAG}"
            echo "- Type: ${VERSION_TYPE}"
            echo "- Debug build: ${DEBUG_BUILD}"
            echo ""
            echo "### Release notes"
            echo "$notes"
          } >> "$GITHUB_STEP_SUMMARY"

  build:
    if: ${{ github.event.inputs.only_description != 'true' }}
    needs: release
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Java
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '21'

      - name: Make Gradle executable
        run: chmod +x gradlew

      - name: Build selected modules
        env:
          TAG: ${{ needs.release.outputs.tag }}
          VERSION_TYPE: ${{ github.event.inputs.version_type }}
          DEBUG_BUILD: ${{ github.event.inputs.debug }}
          PUBLISH_VELOCITY: ${{ github.event.inputs.publish_velocity }}
          PUBLISH_PAPER: ${{ github.event.inputs.publish_paper }}
          PUBLISH_FABRIC: ${{ github.event.inputs.publish_fabric }}
          PUBLISH_NEOFORGE: ${{ github.event.inputs.publish_neoforge }}
          PUBLISH_MINESTOM: ${{ github.event.inputs.publish_minestom }}
        run: |
          set -euo pipefail
          tasks=()
          if [ "$PUBLISH_VELOCITY" = "true" ]; then
            tasks+=(":loader-velocity:build")
          fi
          if [ "$PUBLISH_PAPER" = "true" ]; then
            tasks+=(":loader-paper:build")
          fi
          if [ "$PUBLISH_FABRIC" = "true" ]; then
            tasks+=(":loader-fabric:build")
          fi
          if [ "$PUBLISH_NEOFORGE" = "true" ]; then
            tasks+=(":loader-neoforge:build")
          fi
          if [ "$PUBLISH_MINESTOM" = "true" ]; then
            tasks+=(":loader-minestom:build" ":loader-minestom-ffa:build")
          fi
          if [ ${#tasks[@]} -eq 0 ]; then
            echo "No modules selected to build." >&2
            exit 1
          fi
          ./gradlew clean "${tasks[@]}" -Ptag="$TAG" -Pversion_type="$VERSION_TYPE" -Pdebug="$DEBUG_BUILD"

      - name: Log in to GitHub Container Registry
        if: ${{ github.event.inputs.publish_velocity == 'true' || github.event.inputs.publish_paper == 'true' || github.event.inputs.publish_fabric == 'true' || github.event.inputs.publish_neoforge == 'true' || github.event.inputs.publish_minestom == 'true' }}
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.repository_owner }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push Docker images
        if: ${{ github.event.inputs.publish_velocity == 'true' || github.event.inputs.publish_paper == 'true' || github.event.inputs.publish_fabric == 'true' || github.event.inputs.publish_neoforge == 'true' || github.event.inputs.publish_minestom == 'true' }}
        env:
          TAG: ${{ needs.release.outputs.tag }}
          PUBLISH_VELOCITY: ${{ github.event.inputs.publish_velocity }}
          PUBLISH_PAPER: ${{ github.event.inputs.publish_paper }}
          PUBLISH_FABRIC: ${{ github.event.inputs.publish_fabric }}
          PUBLISH_NEOFORGE: ${{ github.event.inputs.publish_neoforge }}
          PUBLISH_MINESTOM: ${{ github.event.inputs.publish_minestom }}
        run: |
          set -euo pipefail
          IMAGE_PREFIX="ghcr.io/uebliche"
          if [ "$PUBLISH_VELOCITY" = "true" ]; then
            docker build -f docker/Dockerfile.velocity -t "${IMAGE_PREFIX}/hub-velocity:${TAG}" -t "${IMAGE_PREFIX}/hub-velocity:latest" .
            docker push "${IMAGE_PREFIX}/hub-velocity:${TAG}"
            docker push "${IMAGE_PREFIX}/hub-velocity:latest"
          fi
          if [ "$PUBLISH_PAPER" = "true" ]; then
            docker build -f docker/Dockerfile.paper -t "${IMAGE_PREFIX}/hub-paper:${TAG}" -t "${IMAGE_PREFIX}/hub-paper:latest" .
            docker push "${IMAGE_PREFIX}/hub-paper:${TAG}"
            docker push "${IMAGE_PREFIX}/hub-paper:latest"
          fi
          if [ "$PUBLISH_MINESTOM" = "true" ]; then
            docker build -f docker/Dockerfile.minestom-ffa -t "${IMAGE_PREFIX}/hub-ffa:${TAG}" -t "${IMAGE_PREFIX}/hub-ffa:latest" .
            docker push "${IMAGE_PREFIX}/hub-ffa:${TAG}"
            docker push "${IMAGE_PREFIX}/hub-ffa:latest"
          fi

      - name: Upload build artifacts to release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ needs.release.outputs.tag }}
          files: |
            loader-velocity/build/libs/*.jar
            loader-paper/build/libs/*.jar
            loader-fabric/build/libs/*.jar
            loader-neoforge/build/libs/*.jar
            loader-minestom/build/libs/*.jar
            loader-minestom-ffa/build/libs/*.jar
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Publish to Modrinth (Velocity)
        if: ${{ github.event.inputs.publish_velocity == 'true' }}
        env:
          MODRINTH_TOKEN: ${{ secrets.MODRINTH_TOKEN }}
          CHANGELOG: ${{ needs.release.outputs.notes }}
        run: ./gradlew :loader-velocity:modrinth -Ptag=${{ needs.release.outputs.tag }} -Pversion_type=${{ github.event.inputs.version_type }} -Pdebug=${{ github.event.inputs.debug }}

      - name: Publish to Modrinth (Paper)
        if: ${{ github.event.inputs.publish_paper == 'true' }}
        env:
          MODRINTH_TOKEN: ${{ secrets.MODRINTH_TOKEN }}
          CHANGELOG: ${{ needs.release.outputs.notes }}
        run: ./gradlew :loader-paper:modrinth -Ptag=${{ needs.release.outputs.tag }} -Pversion_type=${{ github.event.inputs.version_type }} -Pdebug=${{ github.event.inputs.debug }}

      - name: Publish to Modrinth (Fabric)
        if: ${{ github.event.inputs.publish_fabric == 'true' }}
        env:
          MODRINTH_TOKEN: ${{ secrets.MODRINTH_TOKEN }}
          CHANGELOG: ${{ needs.release.outputs.notes }}
        run: ./gradlew :loader-fabric:modrinth -Ptag=${{ needs.release.outputs.tag }} -Pversion_type=${{ github.event.inputs.version_type }} -Pdebug=${{ github.event.inputs.debug }}

      - name: Publish to Modrinth (NeoForge)
        if: ${{ github.event.inputs.publish_neoforge == 'true' }}
        env:
          MODRINTH_TOKEN: ${{ secrets.MODRINTH_TOKEN }}
          CHANGELOG: ${{ needs.release.outputs.notes }}
        run: ./gradlew :loader-neoforge:modrinth -Ptag=${{ needs.release.outputs.tag }} -Pversion_type=${{ github.event.inputs.version_type }} -Pdebug=${{ github.event.inputs.debug }}

      - name: Publish to Modrinth (Minestom)
        if: ${{ github.event.inputs.publish_minestom == 'true' }}
        env:
          MODRINTH_TOKEN: ${{ secrets.MODRINTH_TOKEN }}
          CHANGELOG: ${{ needs.release.outputs.notes }}
        run: ./gradlew :loader-minestom:modrinth :loader-minestom-ffa:modrinth -Ptag=${{ needs.release.outputs.tag }} -Pversion_type=${{ github.event.inputs.version_type }} -Pdebug=${{ github.event.inputs.debug }}

  update-description:
    if: ${{ github.event.inputs.only_description == 'true' }}
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Java
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '21'

      - name: Make Gradle executable
        run: chmod +x gradlew

      - name: Sync Modrinth description
        env:
          MODRINTH_TOKEN: ${{ secrets.MODRINTH_TOKEN }}
        run: ./gradlew :loader-velocity:modrinthSyncBody -Pdebug=${{ github.event.inputs.debug }}
