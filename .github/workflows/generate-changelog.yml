name: Generate Changelog

on:
  workflow_dispatch:
    inputs:
      release_date:
        description: "Release date (YYYY-MM-DD). Default: today (UTC)."
        required: false
        type: string
      since_ref:
        description: "Git ref/commit to start from (exclusive). Default: day after latest changelog date."
        required: false
        type: string
      until_ref:
        description: "Git ref/commit to end at (inclusive). Default: HEAD."
        required: false
        type: string
      exclude_prefixes:
        description: "Comma-separated commit prefixes to exclude (e.g. chore,ci,build,test)."
        required: false
        type: string

jobs:
  changelog:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Resolve release date
        id: vars
        run: |
          if [ -n "${{ inputs.release_date }}" ]; then
            echo "release_date=${{ inputs.release_date }}" >> "$GITHUB_OUTPUT"
          else
            echo "release_date=$(date -u +%Y-%m-%d)" >> "$GITHUB_OUTPUT"
          fi

      - name: Generate changelog
        run: |
          args=(--release-date "${{ steps.vars.outputs.release_date }}")
          if [ -n "${{ inputs.since_ref }}" ]; then
            args+=(--since-ref "${{ inputs.since_ref }}")
          fi
          if [ -n "${{ inputs.until_ref }}" ]; then
            args+=(--until-ref "${{ inputs.until_ref }}")
          fi
          if [ -n "${{ inputs.exclude_prefixes }}" ]; then
            args+=(--exclude-prefixes "${{ inputs.exclude_prefixes }}")
          fi
          python .github/scripts/generate_changelog.py "${args[@]}"

      - name: Commit changelog
        run: |
          if git diff --quiet; then
            echo "No changelog changes."
            exit 0
          fi
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add CHANGELOG.md
          git commit -m "docs: update changelog for ${{ steps.vars.outputs.release_date }}"
          git push
