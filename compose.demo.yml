name: hub-demo

services:
  velocity:
    image: eclipse-temurin:21-jdk
    container_name: hub-demo-velocity
    working_dir: /app
    volumes:
      # Prebuilt binaries (provide from your build artifacts)
      - ./artifacts/velocity-proxy.jar:/app/velocity.jar:ro
      - ./artifacts/hub-velocity.jar:/app/plugins/hub.jar:ro
      # Configs
      - ./docker/velocity.docker.toml:/app/velocity.toml:ro
      - ./docker/velocity.forwarding.secret:/app/forwarding.secret:ro
      - ./docker/plugins.hub:/app/plugins/hub:ro
    command:
      - bash
      - -lc
      - |
        set -euo pipefail
        mkdir -p plugins
        java -Xms256m -Xmx512m \
          -jar /app/velocity.jar \
          -conf /app/velocity.toml \
          -forwarding-secret-file /app/forwarding.secret
    ports:
      - "25577:25577"
    networks:
      - hub

  lobby:
    image: itzg/minecraft-server:java21
    container_name: hub-demo-lobby
    environment:
      EULA: "TRUE"
      TYPE: "PAPER"
      VERSION: "1.21.11"
      ENABLE_RCON: "false"
      ONLINE_MODE: "false"
      DIFFICULTY: "peaceful"
      MAX_PLAYERS: "20"
    volumes:
      - lobby-data:/data
      - ./artifacts/hub-paper.jar:/data/plugins/HUB.jar:ro
      - ./docker/lobby.server.properties:/data/server.properties:ro
      - ./docker/plugins.hub/config.yml:/data/plugins/HUB/config.yml:ro
    networks:
      - hub

  ffa:
    image: eclipse-temurin:21-jdk
    container_name: hub-demo-ffa
    working_dir: /app
    environment:
      VELOCITY_SECRET: "secret"
    volumes:
      - ./artifacts/hub-minestom-ffa.jar:/app/minestom-ffa.jar:ro
      - ./docker/ffalobby.server.properties:/app/server.properties:ro
    command:
      - bash
      - -lc
      - |
        set -euo pipefail
        java -Xms256m -Xmx512m -jar /app/minestom-ffa.jar
    networks:
      - hub

networks:
  hub:
    driver: bridge

volumes:
  lobby-data:
